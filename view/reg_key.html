<link rel="stylesheet" type="text/css" href="<?php echo $system->ini_get('styles_url');?>reg.css" />
<div style="height:110px;"></div>
<div id="main" class="block">
	<h2>这里是邀请注册页面</h2>
	<div id="ui1">
		<p class="button_div"><a href="<?php echo URLROOT;?>index/reg">点我返回普通注册界面</a><a href="<?php echo URLROOT;?>index/reg">点我去登陆界面</a></p>
		<div class="info_input">
			邀请码：<input type="text" id="key"/><span class="beizhu">邀请码区分大小写</span>
			<br/>
				验证码：
				<img src="<?php echo URLROOT; ?>img/addition.php?name=<?php echo $system->ini_get('reg_ver_ses_name');?>"/>=
				<input type="text" maxlength="3" size="3" id="add"/>　　　　　　　
		</div>
		<div  class="button_div"><a onclick="test_key()">检查邀请码</a></div>
		<p class="beizhu">验证完邀请码后会显示你能用的uid及其他特权，选择并完善用户信息后即可完成注册</p>
	</div>
	<div id="ui2" style="display:none;">
		<div class="beizhu">您的邀请码已经通过验证，您需要完成以下信息完成注册</div>
		<div class="info_input">
			<div class="info_input">
					u&nbsp;i&nbsp;d&nbsp;：
					<select id="uid">
					</select>
				<br/>
					用户组：
					<select id="group">
						<option value="auto">默认</option>
					</select>
				<br/>
				用&nbsp;户&nbsp;名&nbsp;<input type="text" id="username"/>
				<br/>
				密　　码<input type="password" id="password1"/>
				<br/>
				确认密码<input type="password" id="password2"/>
			</div>
			<p class="button_div"><a onclick="up()"/>注册</a></p>
		</div>
	</div>
	<div id="ui3" style="display:none;">
		hh
	</div>
</div>
<script>
	$('img')[0].onclick=function(){
		this.src='<?php echo URLROOT; ?>img/addition.php?name=<?php echo $system->ini_get('reg_ver_ses_name');?>&t='+Math.random();
	}
	var info=[];
	var ver;//暂存验证码
	
	function to_ui1(){
		$("#ui1").style.display="";
		$("#ui2").style.display="none";
	}
	function to_ui2(){
		$("#ui1").style.display="none";
		$("#ui2").style.display="";
	}
	//第一个回调函数
	function cb1(ajax){
		if(ajax.json){
			if(ajax.json.error){
				$('input')[0].value='';
				$('img')[0].onclick();
				myScript.message('验证失败','服务器没有发现匹配您邀请码的uid。。。','#F00');
				return;
			}
			to_ui2();
			var uid=$("#uid");
			var t;
			if(ajax.json.auto){
				is_in=true;
				t=$.set('option',uid);
				t.innerHTML='自动';
				t.value='auto';
			}
			for(i in ajax.json.uids){
				//$('#main').innerHTML+='<input type="button" value="'+ajax.json.uids[i]+'"/>';
				if(ajax.json.uids[i]['isused']){
					continue;
				}
				is_in=true;
				t=$.set('option',uid);
				t.value=ajax.json.uids[i]['uid'];
				t.innerHTML=ajax.json.uids[i]['uid'];
			}
			if(!is_in){
				$('#main').innerHTML=temp;
				$('input')[0].value=info['key'];
				myScript.message('邀请码已失效','此邀请码可用的uid已全部用完','orange');
				return;
			}
		}else{
			$('img')[0].onclick();
			myScript.show(ajax.text);
		}
	}
	//第一次提交函数
	function test_key(){
		if($("#add").value==""){
			myScript.message("错误","你必须填写验证码",'#BB0');
			return;
		}
		var ajax=$.ajax();
		ajax.page='<?php echo URLROOT;?>p/reg_for_key?stp=1';
		ajax.data='key='+$("#key").value+'&<?php echo $system->ini_get('reg_ver_ses_name');?>='+$("#add").value;
		ajax.callback=cb1;
		ajax.send();
	}

	//第二次提交
	function up(){
		if(!$('#username').value){
			myScript.message("错误",'您必须输入您的用户名',"#BB0");
			return;
		}
		if(!$('#password1').value){
			myScript.show("错误",'您必须设置您的密码',"#BB0");
			return;
		}
		if($('#password1').value!=$('#password2').value){
			myScript.show("错误",'你两次输入的密码不一致，请检查',"#BB0");
			return;
		}
		var ajax=$.ajax();
		ajax.page='<?php echo URLROOT;?>p/reg_for_key?stp=2';
		ajax.setCont({
			'key':$("#key").value,
			'username':$('#username').value,
			'password':$('#password1').value,
			'uid':$('select')[0].value,
			'group':$('select')[1].value,
			'<?php echo $system->ini_get('reg_ver_ses_name');?>':$("#add").value
		});
		ajax.callback=function(ajax){
			if(ajax.json){
				if(ajax.json.error){
					myScript.show(ajax.json.error);
				}else{
					myScript.show('注册成功')
				}
			}else{
				myScript.show(ajax.text);
			}
		}
		ajax.send();
	}
</script>